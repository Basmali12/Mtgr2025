<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <!-- ========== META & SEO ========== -->
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <title>فن التكلوجيا الحديث | كورسات مجانية و VIP - برامج مهكرة ومعدلة وقوالب وأدوات</title>

  <meta name="description" content="فن التكلوجيا الحديث: متجر كورسات مجانية و VIP، برامج تعليم، أدوات تكنولوجيا، برامج مهكرة ومعدلة للتجربة، قوالب جاهزة، سكربتات، سيرفرات، وثغرات تعليمية في مجال الأمن والحماية.">
  <meta name="keywords" content="فن التكلوجيا الحديث, متجر كورسات, كورسات مجانية, كورسات VIP, برامج تعليم, برامج مهكرة, برامج معدلة, برامج هكر, ثغرات تعليمية, قوالب جاهزة, قوالب بلوجر, سكربتات, أدوات اختراق تعليمية, أدوات تكنولوجيا, دورات برمجة, دورات تصميم, سيرفرات مدفوعة, سيرفرات IPTV, ذكاء اصطناعي, AI, ادوات هكر للتعليم, ادوات حماية, قنوات تيليجرام تعليمية">
  <meta name="author" content="Basm / فن التكلوجيا الحديث">

  <!-- Open Graph -->
  <meta property="og:title" content="فن التكلوجيا الحديث – كورسات، برامج، محتوى VIP">
  <meta property="og:description" content="كورسات مجانية ومدفوعة، برامج تعليم، أدوات مهكرة ومعدلة للتجربة، محتوى VIP بسعر رمزي، كل شيء في مكان واحد.">
  <meta property="og:image" content="https://k.top4top.io/p_3620yt6g21.jpg">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://basmali12.github.io/Mtgr2025/">

  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="فن التكلوجيا الحديث – كورسات و أدوات VIP">
  <meta name="twitter:description" content="متجر كورسات + برامج مهكرة ومعدلة للتجربة + أدوات تكنولوجيا حديثة.">
  <meta name="twitter:image" content="https://k.top4top.io/p_3620yt6g21.jpg">

  <!-- Favicon -->
  <link rel="icon" href="https://k.top4top.io/p_3620yt6g21.jpg" type="image/jpeg">

  <!-- Fonts & Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />

  <style>
    :root {
      --bg: #020617;
      --card: rgba(15,23,42,0.98);
      --accent: #22d3ee;
      --accent2: #a855f7;
      --accent3: #facc15;
      --danger: #ef4444;
      --success: #10b981;
      --border: rgba(148,163,184,0.35);
      --text: #e5e7eb;
      --muted: #9ca3af;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:"Tajawal",system-ui,sans-serif;
      background:
        radial-gradient(circle at top,rgba(56,189,248,0.16),transparent 60%),
        radial-gradient(circle at bottom,rgba(168,85,247,0.16),transparent 55%),
        linear-gradient(135deg,#020617,#020617 40%,#030b1e);
      color:var(--text);
      min-height:100vh;
    }

    header{
      padding:10px 14px;
      border-bottom:1px solid var(--border);
      background:linear-gradient(90deg,rgba(15,23,42,0.98),rgba(15,23,42,0.9));
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .logo{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .logo-icon{
      width:34px;height:34px;border-radius:50%;
      border:2px solid var(--accent);
      display:flex;align-items:center;justify-content:center;
      box-shadow:0 0 18px rgba(34,211,238,0.7);
      background:radial-gradient(circle,rgba(34,211,238,0.2),transparent);
    }
    .logo-icon img{
      width:22px;height:22px;border-radius:50%;object-fit:cover;
    }
    .logo-text{display:flex;flex-direction:column;line-height:1.1}
    .logo-title{font-size:16px;font-weight:700}
    .logo-sub{font-size:11px;color:var(--muted)}

    .header-right{
      display:flex;
      flex-direction:column;
      align-items:flex-end;
      gap:4px;
    }

    .user-chip{
      font-size:11px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid var(--border);
      background:rgba(15,23,42,0.95);
      display:flex;
      flex-direction:column;
      align-items:flex-end;
      gap:2px;
    }
    .user-chip span:last-child{color:var(--accent);font-weight:600}

    .account-btn{
      border-radius:999px;
      border:1px solid var(--border);
      background:rgba(15,23,42,0.96);
      color:var(--muted);
      padding:4px 8px;
      font-size:11px;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:4px;
    }

    main{max-width:1100px;margin:10px auto 20px;padding:0 10px}

    .user-status-bar{
      background:rgba(15,23,42,0.97);
      border-radius:14px;
      border:1px solid var(--border);
      padding:8px 10px;
      margin-bottom:10px;
      display:grid;
      grid-template-columns:minmax(0,2.2fr) minmax(0,2fr);
      gap:6px;
      align-items:center;
    }
    @media(max-width:768px){
      .user-status-bar{
        grid-template-columns:1fr;
      }
    }
    .user-status-text{font-size:11px;color:var(--muted);}
    .user-status-pill{display:flex;gap:6px;align-items:center;flex-wrap:wrap;}
    .badge{
      padding:3px 7px;
      border-radius:999px;
      font-size:11px;
      border:1px solid var(--border);
      display:inline-flex;
      align-items:center;
      gap:4px;
    }
    .badge.vip{border-color:var(--accent3);color:var(--accent3);}
    .badge.notvip{border-color:var(--muted);color:var(--muted);}
    .btn-vip{
      border-radius:999px;
      border:none;
      padding:6px 10px;
      font-size:11px;
      cursor:pointer;
      background:linear-gradient(90deg,#22c55e,#16a34a);
      color:#022c22;
      display:inline-flex;
      align-items:center;
      gap:5px;
      font-weight:600;
    }
    .btn-vip i{font-size:12px}
    .vip-pricing{
      font-size:11px;
      color:var(--muted);
    }
    .vip-pricing span{color:var(--accent3);font-weight:600}

    .profile-box{
      background:rgba(15,23,42,0.96);
      border-radius:14px;
      border:1px dashed rgba(148,163,184,0.7);
      padding:8px 10px;
      margin-bottom:12px;
      font-size:11px;
    }
    .profile-row{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      align-items:center;
      margin-top:6px;
    }
    .profile-row input{
      background:rgba(15,23,42,0.96);
      border-radius:999px;
      border:1px solid rgba(51,65,85,0.95);
      padding:5px 8px;
      color:var(--text);
      font-size:11px;
      min-width:120px;
    }
    .profile-row button{
      border-radius:999px;
      border:none;
      padding:5px 10px;
      font-size:11px;
      cursor:pointer;
      background:rgba(37,99,235,0.95);
      color:white;
    }

    .search-box{
      margin-bottom:8px;
      display:flex;
      gap:6px;
    }
    .search-box input{
      flex:1;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background:rgba(15,23,42,0.96);
      color:var(--text);
      font-size:12px;
    }
    .search-box button{
      border-radius:999px;
      border:1px solid var(--border);
      background:rgba(15,23,42,0.96);
      color:var(--muted);
      padding:4px 8px;
      font-size:11px;
      cursor:pointer;
    }

    .filters{
      display:flex;
      gap:6px;
      flex-wrap:wrap;
      margin-bottom:8px;
      font-size:11px;
    }
    .filter-chip{
      padding:4px 8px;
      border-radius:999px;
      border:1px solid var(--border);
      background:rgba(15,23,42,0.96);
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:4px;
      color:var(--muted);
    }
    .filter-chip.active{
      border-color:var(--accent);
      color:var(--accent);
      box-shadow:0 0 12px rgba(34,211,238,0.4);
    }

    .products-grid{
      display:grid;
      grid-template-columns:repeat(2,minmax(0,1fr));
      gap:10px;
    }
    @media(min-width:900px){
      .products-grid{grid-template-columns:repeat(4,minmax(0,1fr));}
    }
    @media(min-width:1200px){
      .products-grid{grid-template-columns:repeat(6,minmax(0,1fr));}
    }

    .product-card{
      background:rgba(15,23,42,0.98);
      border-radius:14px;
      border:1px solid rgba(55,65,81,0.9);
      padding:6px;
      display:flex;
      flex-direction:column;
      gap:4px;
      position:relative;
      overflow:hidden;
    }
    .product-card.vip{
      box-shadow:0 0 18px rgba(250,204,21,0.35);
      border-color:rgba(250,204,21,0.85);
    }
    .product-image-box{
      width:100%;
      padding-top:100%;
      border-radius:10px;
      overflow:hidden;
      background:radial-gradient(circle,rgba(15,23,42,0.7),#020617);
      position:relative;
    }
    .product-image-box img{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      object-fit:cover;
    }
    .product-title{
      font-size:12px;
      font-weight:600;
      margin-top:2px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .rating-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-top:3px;
      font-size:11px;
    }
    .rating-stars i{
      cursor:pointer;
      margin-inline-start:2px;
      color:#facc15;
    }
    .rating-stars i.fa-regular{opacity:0.4;}
    .rating-num{color:var(--muted);}

    .product-meta{
      display:flex;
      justify-content:space-between;
      align-items:center;
      font-size:10px;
      color:var(--muted);
      margin-top:2px;
    }

    .product-footer{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-top:2px;
      gap:4px;
    }
    .category-text{font-size:10px;color:var(--muted);}
    .badge-small{
      font-size:10px;
      padding:2px 6px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.8);
    }
    .badge-small.vip{border-color:var(--accent3);color:var(--accent3);}

    .product-actions{
      display:flex;
      align-items:center;
      gap:4px;
    }
    .btn-enter{
      border:none;
      border-radius:999px;
      padding:4px 10px;
      font-size:11px;
      cursor:pointer;
      background:#ef4444;
      color:#fee2e2;
      display:inline-flex;
      align-items:center;
      gap:4px;
    }
    .btn-share{
      border:none;
      border-radius:999px;
      padding:4px 7px;
      font-size:11px;
      cursor:pointer;
      background:rgba(15,23,42,0.96);
      color:var(--muted);
      display:inline-flex;
      align-items:center;
      gap:3px;
    }

    .course-overlay{
      position:fixed;
      inset:0;
      background:rgba(15,23,42,0.96);
      z-index:40;
      display:none;
      flex-direction:column;
    }
    .course-overlay.active{display:flex;}
    .course-header{
      padding:8px 10px;
      border-bottom:1px solid var(--border);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:6px;
      background:rgba(15,23,42,0.98);
    }
    .course-header button{
      border:none;
      background:rgba(15,23,42,0.96);
      border-radius:999px;
      padding:4px 8px;
      color:var(--text);
      font-size:11px;
      display:inline-flex;
      align-items:center;
      gap:4px;
      cursor:pointer;
    }
    .course-title{font-size:13px;font-weight:600;}
    .course-body{
      padding:10px;
      overflow:auto;
      flex:1;
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .preview-box{
      max-width:480px;
      margin:0 auto;
      border-radius:14px;
      overflow:hidden;
      border:1px solid rgba(55,65,81,0.9);
      background:#000;
    }
    .preview-box iframe,
    .preview-box video{
      width:100%;
      height:260px;
      display:block;
    }
    @media(max-width:600px){
      .preview-box iframe,
      .preview-box video{height:210px;}
    }

    .section-box{
      background:rgba(15,23,42,0.98);
      border-radius:14px;
      border:1px solid var(--border);
      padding:8px 10px;
      font-size:12px;
    }
    .section-title{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:6px;
      font-size:12px;
    }
    .section-title span{display:flex;align-items:center;gap:6px;}
    .field-list{display:flex;flex-direction:column;gap:6px;}
    .field-item{
      padding:6px 8px;
      border-radius:10px;
      border:1px solid rgba(51,65,85,0.9);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:6px;
      font-size:11px;
    }
    .field-main{display:flex;align-items:center;gap:6px;}
    .field-actions a{
      font-size:11px;
      text-decoration:none;
      color:var(--accent);
    }
    .field-actions span{
      font-size:11px;
      color:#fecaca;
    }
    .vip-locked{
      font-size:11px;
      color:#fecaca;
      background:rgba(185,28,28,0.15);
      border-radius:10px;
      padding:6px 8px;
      border:1px solid rgba(248,113,113,0.7);
      margin-top:6px;
    }

    .inline-play-btn{
      border-radius:999px;
      border:none;
      padding:4px 8px;
      font-size:11px;
      cursor:pointer;
      background:#0ea5e9;
      color:#0f172a;
      margin-inline-end:4px;
    }

    .seo-footer{
      font-size:10px;
      color:var(--muted);
      opacity:0.8;
      margin-top:12px;
      padding:0 4px 8px;
    }

    #coursesIndex{
      margin-top:14px;
      font-size:12px;
    }

    .account-modal{
      position:fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      z-index:50;
    }
    .account-modal.open{display:flex;}
    .account-modal::before{
      content:"";
      position:absolute;
      inset:0;
      background:rgba(15,23,42,0.8);
      backdrop-filter:blur(4px);
    }
    .account-card{
      position:relative;
      background:var(--card);
      border-radius:16px;
      border:1px solid var(--border);
      padding:14px;
      width:90%;
      max-width:360px;
      z-index:1;
      font-size:12px;
    }
    .account-row{
      margin-top:6px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:6px;
    }
    .eye-btn,
    .logout-small{
      border-radius:999px;
      border:1px solid var(--border);
      background:rgba(15,23,42,0.96);
      color:var(--muted);
      padding:4px 8px;
      font-size:11px;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:4px;
    }
    .account-close{
      position:absolute;
      top:8px;
      inset-inline-end:8px;
      border:none;
      background:transparent;
      color:var(--muted);
      cursor:pointer;
    }

    #welcomeAdWrapper{
      position:fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      z-index:60;
    }
    #welcomeAdWrapper.active{
      display:flex;
    }
    #welcomeAdBackdrop{
      position:absolute;
      inset:0;
      background:rgba(15,23,42,0.86);
      backdrop-filter:blur(4px);
    }
    #welcomeAdBox{
      position:relative;
      z-index:1;
      max-width:420px;
      width:90%;
      background:radial-gradient(circle at top,#0f172a,#020617);
      border-radius:20px;
      border:1px solid rgba(148,163,184,0.4);
      padding:16px 14px;
      box-shadow:0 0 35px rgba(56,189,248,0.5);
    }
    #welcomeAdTitle{
      font-size:15px;
      margin-bottom:8px;
      display:flex;
      align-items:center;
      gap:8px;
    }
    #welcomeAdTitle i{
      color:#22d3ee;
    }
    #welcomeAdText{
      font-size:13px;
      color:#e5e7eb;
      margin-bottom:14px;
      line-height:1.7;
    }
    #welcomeAdNote{
      font-size:11px;
      color:#9ca3af;
      margin-bottom:10px;
    }
    #welcomeSkipBtn{
      display:inline-flex;
      align-items:center;
      gap:6px;
      border:none;
      border-radius:999px;
      padding:7px 14px;
      font-size:13px;
      cursor:pointer;
      background:linear-gradient(135deg,#f97316,#ec4899);
      color:#0b1120;
      font-weight:600;
    }
  </style>
</head>

<body>

<header>
  <div class="logo">
    <div class="logo-icon">
      <img src="https://k.top4top.io/p_3620yt6g21.jpg" alt="Logo">
    </div>
    <div class="logo-text">
      <div class="logo-title">فن التكلوجيا الحديث</div>
      <div class="logo-sub">متجر كورسات – تكنولوجيا حديثة &amp; VIP</div>
    </div>
  </div>
  <div class="header-right">
    <div class="user-chip">
      <span>حالة الحساب: <strong id="accountStateText">...</strong></span>
      <span>ID: <span id="userIdChip">----</span></span>
      <span id="visitsLabel">الزوار: --</span>
    </div>
    <button id="accountBtn" class="account-btn">
      <i class="fa-solid fa-user"></i> حسابي
    </button>
  </div>
</header>

<main>

  <section class="user-status-bar">
    <div>
      <div class="user-status-text" id="vipShortText">
        يتم تحديد حالة اشتراكك من السيرفر...
      </div>
      <div class="vip-pricing">
        الاشتراك في <span>VIP</span> لفتح مزايا الموقع:
        شهر واحد <span>5$</span> – ثلاثة أشهر <span>10$</span>.
      </div>
    </div>
    <div class="user-status-pill">
      <button class="btn-vip" id="vipWhatsappBtn">
        <i class="fa-brands fa-whatsapp"></i>
        أريد تفعيل اشتراك VIP
      </button>
      <span class="badge" id="vipStateBadge"><i class="fa-solid fa-circle-info"></i> يتم التحقق ...</span>
    </div>
  </section>

  <section class="profile-box">
    <div>حسابك محفوظ على هذا الجهاز. إذا رجعت لاحقًا، استخدم نفس <strong>ID</strong> وكلمة السر.</div>
    <div class="profile-row">
      <span>ID الحالي:</span>
      <span id="userIdDisplay" style="font-weight:600;"></span>
    </div>
    <div class="profile-row" id="passwordRow">
      <span>أنشئ كلمة سر:</span>
      <input type="password" id="passwordInput" placeholder="٢-١٢ حرف / رقم">
      <button id="savePasswordBtn">حفظ الحساب</button>
      <span id="passwordStatus"></span>
    </div>
  </section>

  <section class="search-box">
    <input type="text" id="searchInput" placeholder="ابحث عن كورس أو تطبيق أو منتج...">
    <button id="clearSearchBtn"><i class="fa-solid fa-xmark"></i></button>
  </section>

  <section class="filters">
    <button class="filter-chip active" data-filter="all">الكل</button>
    <button class="filter-chip" data-filter="public">مفتوح</button>
    <button class="filter-chip" data-filter="vip">VIP</button>
  </section>

  <section class="products-grid" id="productsGrid"></section>

  <section id="coursesIndex">
    <h2 style="font-size:13px;margin-bottom:6px;">فهرس جميع المنتجات والتصنيفات</h2>
    <ul id="coursesIndexList" style="list-style:none;padding:0;margin:0;display:flex;flex-direction:column;gap:4px;"></ul>
  </section>

  <footer class="seo-footer">
    فن التكلوجيا الحديث هو متجر كورسات مجانية ومدفوعة، كورسات VIP، برامج تعليم، تطبيقات، سكربتات، برامج مهكرة ومعدلة للتجربة، أدوات هكر تعليمية، أدوات حماية، قوالب جاهزة، سيرفرات، وثغرات تعليمية في مجال الأمن والحماية والتكنولوجيا الحديثة.
  </footer>

</main>

<!-- إعلان ترحيبي -->
<div id="welcomeAdWrapper">
  <div id="welcomeAdBackdrop"></div>
  <div id="welcomeAdBox">
    <div id="welcomeAdTitle">
      <i class="fa-solid fa-bullhorn"></i>
      <span>إعلان من إدارة المتجر</span>
    </div>
    <div id="welcomeAdText"></div>
    <div id="welcomeAdNote">يمكنك إغلاق هذه الرسالة بالضغط على زر تخطي.</div>
    <button id="welcomeSkipBtn">
      <i class="fa-solid fa-arrow-left"></i>
      تخطي
    </button>
  </div>
</div>

<div class="course-overlay" id="courseOverlay">
  <div class="course-header">
    <button id="courseBackBtn"><i class="fa-solid fa-arrow-right"></i> رجوع للمتجر</button>
    <div class="course-title" id="courseTitleHead"></div>
  </div>
  <div class="course-body">
    <div id="coursePreview" class="preview-box" style="display:none;"></div>

    <div class="section-box" id="openSection">
      <div class="section-title">
        <span><i class="fa-solid fa-unlock"></i> المحتوى المفتوح / القديم</span>
        <small style="color:var(--muted);font-size:10px;">يُعرض للجميع</small>
      </div>
      <div class="field-list" id="openFields"></div>
      <div id="noOpenFields" style="font-size:11px;color:var(--muted);display:none;">
        لا توجد حقول مفتوحة في هذا الكورس حاليًا.
      </div>
    </div>

    <div class="section-box" id="vipSection">
      <div class="section-title">
        <span><i class="fa-solid fa-crown"></i> محتوى VIP</span>
        <span class="badge-small vip" id="vipSectionBadge">مقفول</span>
      </div>
      <div class="field-list" id="vipFields"></div>
      <div class="vip-locked" id="vipLockedMsg">
        هذا المحتوى VIP – عليك الاشتراك لكي تتمتع باستخدام كل الحقول المقفولة.
        اضغط على زر الاشتراك في الأعلى لتواصل الأدمن عبر الواتساب.
      </div>
    </div>
  </div>
</div>

<!-- نافذة حسابي -->
<div id="accountModal" class="account-modal">
  <div class="account-card">
    <button class="account-close" id="accountCloseBtn"><i class="fa-solid fa-xmark"></i></button>
    <h3 style="font-size:14px;margin-bottom:4px;">حسابي</h3>
    <p style="font-size:11px;color:var(--muted);">هذه معلومات حسابك المحفوظ على هذا الجهاز.</p>
    <div class="account-row">
      <span>ID:</span>
      <span id="accIdText" style="font-weight:600;"></span>
    </div>
    <div class="account-row">
      <span>كلمة السر:</span>
      <span id="accPassText" style="direction:ltr;"></span>
      <button class="eye-btn" id="passEyeBtn"><i class="fa-solid fa-eye"></i></button>
    </div>
    <div id="accNote" style="font-size:10px;color:var(--muted);margin-top:6px;"></div>
    <div style="margin-top:10px;text-align:left;">
      <button class="logout-small" id="storeLogoutBtn">
        <i class="fa-solid fa-arrow-right-from-bracket"></i> تسجيل خروج
      </button>
    </div>
  </div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyDa_20ADHMOiUhueZL9PS3WHmA89fGLfhk",
    authDomain: "mtgr-5feb9.firebaseapp.com",
    projectId: "mtgr-5feb9",
    storageBucket: "mtgr-5feb9.firebasestorage.app",
    messagingSenderId: "1097780736802",
    appId: "1:1097780736802:web:89ea173d277ce529a56b7b",
    measurementId: "G-JWNEHDQ31F"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  const WHATSAPP_NUMBER = "9647729373260";

  // تحسين سرعة الصور: استخدام thumbnail أصغر من Google Drive
  function normalizeDriveImageUrl(url){
    if(!url) return "";
    try{
      if(url.includes("drive.google.com/thumbnail")) return url;

      let fileId = null;

      if(url.includes("/d/")){
        const m = url.match(/\/d\/([^/]+)/);
        if(m && m[1]) fileId = m[1];
      }

      if(!fileId && url.includes("id=")){
        const m2 = url.match(/[?&]id=([^&]+)/);
        if(m2 && m2[1]) fileId = m2[1];
      }

      if(fileId){
        // حجم متوسط لسرعة أعلى وجودة كافية
        return "https://drive.google.com/thumbnail?id="+fileId+"&sz=w800";
      }
      return url;
    }catch(e){
      return url;
    }
  }

  // كشف أن الرابط فيديو (يوتيوب / درايف / mp4...)
  function isVideoUrl(url){
    if(!url) return false;
    const u = url.toLowerCase();
    if (u.includes("youtube.com") || u.includes("youtu.be")) return true;
    if (u.includes("drive.google.com")) return true;
    return u.endsWith(".mp4") || u.endsWith(".webm") || u.endsWith(".ogg");
  }

  // إنشاء عنصر الفيديو (iframe أو video)
  function buildVideoElement(url, poster){
    if(!url) return "";

    const u = url.toLowerCase();

    // Google Drive
    if(u.includes("drive.google.com")){
      let fileId = null;
      try{
        if(url.includes("/d/")){
          const m = url.match(/\/d\/([^/]+)/);
          if(m && m[1]) fileId = m[1];
        }
        if(!fileId && url.includes("id=")){
          const m2 = url.match(/[?&]id=([^&]+)/);
          if(m2 && m2[1]) fileId = m2[1];
        }
      }catch(e){}
      if(!fileId) return '<a href="'+url+'" target="_blank">فتح الفيديو</a>';
      const embed = "https://drive.google.com/file/d/"+fileId+"/preview";
      return '<iframe src="'+embed+'" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>';
    }

    // YouTube
    if(u.includes("youtube.com") || u.includes("youtu.be")){
      let videoId = "";
      try{
        if(u.includes("youtube.com")){
          const params = new URL(url).searchParams;
          videoId = params.get("v") || "";
        }else{
          const parts = url.split("/");
          videoId = parts[parts.length - 1];
        }
      }catch(e){}
      if(!videoId) return '<a href="'+url+'" target="_blank">فتح الفيديو</a>';
      const embed = "https://www.youtube.com/embed/" + videoId;
      return '<iframe src="'+embed+'" frameborder="0" allowfullscreen></iframe>';
    }

    // ملفات mp4 مباشرة
    const posterAttr = poster ? ' poster="'+poster+'"' : "";
    return '<video controls src="'+url+'"'+posterAttr+'></video>';
  }

  let currentUserId = null;
  let isVip = false;
  let vipUntil = null;
  let products = [];
  let currentFilter = "all";
  let searchTerm = "";
  let userPassword = null;
  let passTimer = null;
  let ratedProducts = JSON.parse(localStorage.getItem("FTM_RATED") || "[]");

  const userIdChip      = document.getElementById("userIdChip");
  const userIdDisplay   = document.getElementById("userIdDisplay");
  const accountStateTxt = document.getElementById("accountStateText");
  const vipShortText    = document.getElementById("vipShortText");
  const vipStateBadge   = document.getElementById("vipStateBadge");
  const vipBtn          = document.getElementById("vipWhatsappBtn");
  const visitsLabel     = document.getElementById("visitsLabel");

  const passwordInput  = document.getElementById("passwordInput");
  const savePassBtn    = document.getElementById("savePasswordBtn");
  const passwordStatus = document.getElementById("passwordStatus");
  const passwordRow    = document.getElementById("passwordRow");

  const productsGrid   = document.getElementById("productsGrid");
  const filterChips    = document.querySelectorAll(".filter-chip");
  const searchInput    = document.getElementById("searchInput");
  const clearSearchBtn = document.getElementById("clearSearchBtn");

  const overlay        = document.getElementById("courseOverlay");
  const backBtn        = document.getElementById("courseBackBtn");
  const courseTitleHead= document.getElementById("courseTitleHead");
  const coursePreview  = document.getElementById("coursePreview");
  const openFieldsBox  = document.getElementById("openFields");
  const vipFieldsBox   = document.getElementById("vipFields");
  const noOpenFields   = document.getElementById("noOpenFields");
  const vipLockedMsg   = document.getElementById("vipLockedMsg");
  const vipSectionBadge= document.getElementById("vipSectionBadge");

  const accountBtn     = document.getElementById("accountBtn");
  const accountModal   = document.getElementById("accountModal");
  const accountCloseBtn= document.getElementById("accountCloseBtn");
  const accIdText      = document.getElementById("accIdText");
  const accPassText    = document.getElementById("accPassText");
  const passEyeBtn     = document.getElementById("passEyeBtn");
  const accNote        = document.getElementById("accNote");
  const storeLogoutBtn = document.getElementById("storeLogoutBtn");

  const welcomeAdWrapper = document.getElementById("welcomeAdWrapper");
  const welcomeAdTextEl  = document.getElementById("welcomeAdText");
  const welcomeSkipBtn   = document.getElementById("welcomeSkipBtn");

  function showWelcomeAd(message){
    if(!welcomeAdWrapper || !welcomeAdTextEl) return;
    welcomeAdTextEl.textContent = message;
    welcomeAdWrapper.classList.add("active");
  }

  if(welcomeSkipBtn && welcomeAdWrapper){
    welcomeSkipBtn.addEventListener("click", ()=>{
      welcomeAdWrapper.classList.remove("active");
    });
  }

  async function loadWelcomeAd(){
    try{
      const snap = await db.collection("config").doc("store").get();
      if(!snap.exists) return;
      const data = snap.data() || {};
      if(data.welcomeEnabled === true && data.welcomeText && String(data.welcomeText).trim() !== ""){
        showWelcomeAd(String(data.welcomeText));
      }
    }catch(err){
      console.error("welcomeAd error:", err);
    }
  }

  function generateUserId(){
    const rand = Math.floor(100000 + Math.random()*900000);
    return "U" + rand;
  }

  async function initUser(){
    currentUserId = localStorage.getItem("FTM_USER_ID");
    let userPassLS  = localStorage.getItem("FTM_USER_PASS");

    if(!currentUserId){
      currentUserId = generateUserId();
      localStorage.setItem("FTM_USER_ID", currentUserId);
    }

    userIdChip.textContent    = currentUserId;
    userIdDisplay.textContent = currentUserId;

    const userRef  = db.collection("users").doc(currentUserId);
    const userSnap = await userRef.get();

    if(!userSnap.exists){
      userPassword = userPassLS || "";
      await userRef.set({
        id: currentUserId,
        password: userPassword || "",
        isVip: false,
        vipUntil: null,
        createdAt: new Date().toISOString()
      });
      isVip = false;
      vipUntil = null;
    }else{
      const data = userSnap.data();
      isVip = !!data.isVip;
      vipUntil = data.vipUntil ? new Date(data.vipUntil) : null;
      userPassword = data.password || userPassLS || "";
    }

    if(userPassword){
      localStorage.setItem("FTM_USER_PASS", userPassword);
      passwordInput.value = "";
      passwordRow.style.display = "none";
      passwordStatus.textContent = "كلمة السر محفوظة. يمكنك مشاهدتها من أيقونة (حسابي) في الأعلى.";
      passwordStatus.style.color = "#9ca3af";
    }else if(userPassLS){
      passwordInput.value = userPassLS;
    }

    updateVipUI();

    const baseText = encodeURIComponent("أريد تفعيل اشتراك VIP في متجر فن التكلوجيا الحديث. ID: " + currentUserId);
    const waLink = "https://wa.me/" + WHATSAPP_NUMBER + "?text=" + baseText;
    vipBtn.addEventListener("click", () => {
      window.open(waLink, "_blank");
    });
  }

  function updateVipUI(){
    const now = new Date();
    let activeVip = false;
    if(isVip && vipUntil && vipUntil > now) {
      activeVip = true;
    }

    if(activeVip){
      accountStateTxt.textContent = "مشترك (VIP)";
      accountStateTxt.style.color = "#22c55e";
      vipShortText.textContent = "حسابك مفعل VIP – يمكنك الوصول إلى جميع الحقول المقفولة داخل الدورات.";
      vipStateBadge.innerHTML = '<i class="fa-solid fa-crown"></i> حسابك VIP نشط';
      vipStateBadge.classList.remove("notvip");
      vipStateBadge.classList.add("vip");
      vipLockedMsg.style.display = "none";
      vipSectionBadge.textContent = "مفتوح لك";
    }else{
      accountStateTxt.textContent = "غير مشترك";
      accountStateTxt.style.color = "#f97316";
      vipShortText.textContent = "حالياً تستخدم الحساب المجاني – يمكن مشاهدة المحتوى المفتوح فقط، محتوى VIP يحتاج اشتراك.";
      vipStateBadge.innerHTML = '<i class="fa-solid fa-lock"></i> غير مشترك';
      vipStateBadge.classList.remove("vip");
      vipStateBadge.classList.add("notvip");
      vipLockedMsg.style.display = "block";
      vipSectionBadge.textContent = "مقفول";
    }
  }

  async function initVisitors(){
    if(!visitsLabel) return;
    try{
      const ref = db.collection("stats").doc("global");
      const newCount = await db.runTransaction(async (tx)=>{
        const snap = await tx.get(ref);
        let current = 0;
        if(snap.exists && typeof snap.data().visits === "number"){
          current = snap.data().visits;
        }
        const next = current + 1;
        tx.set(ref,{visits:next},{merge:true});
        return next;
      });
      visitsLabel.textContent = "الزوار: " + newCount;
    }catch(e){
      console.error(e);
      visitsLabel.textContent = "الزوار: --";
    }
  }

  savePassBtn.addEventListener("click", async () => {
    const pass = passwordInput.value.trim();
    if(pass.length < 2 || pass.length > 12){
      passwordStatus.textContent = "كلمة السر بين ٢ و١٢ رمز.";
      passwordStatus.style.color = "#fecaca";
      return;
    }
    try{
      await db.collection("users").doc(currentUserId).set({
        id: currentUserId,
        password: pass,
        isVip,
        vipUntil: vipUntil ? vipUntil.toISOString() : null
      }, { merge:true });

      localStorage.setItem("FTM_USER_PASS", pass);
      userPassword = pass;
      passwordStatus.textContent = "تم حفظ الحساب.";
      passwordStatus.style.color = "#22c55e";
      passwordRow.style.display = "none";
    }catch(e){
      console.error(e);
      passwordStatus.textContent = "خطأ في الحفظ.";
      passwordStatus.style.color = "#fecaca";
    }
  });

  searchInput.addEventListener("input", ()=>{
    searchTerm = searchInput.value.trim().toLowerCase();
    renderProducts();
    renderCoursesIndex();
  });
  clearSearchBtn.addEventListener("click", ()=>{
    searchInput.value = "";
    searchTerm = "";
    renderProducts();
    renderCoursesIndex();
  });

  async function loadProducts(){
    // ممكن لاحقاً نضيف limit لو صار عدد المنتجات كبير
    const snap = await db.collection("products").orderBy("id","asc").get();
    products = [];
    snap.forEach(docSnap => {
      const data = docSnap.data();
      products.push(data);
    });
    renderProducts();
    renderCoursesIndex();

    const params = new URLSearchParams(window.location.search);
    const pid = params.get("p");
    if(pid){
      const prod = products.find(p => String(p.id) === String(pid));
      if(prod) openCourse(prod);
    }
  }

  // فلترة الكورسات حسب accessVip
  function renderProducts(){
    productsGrid.innerHTML = "";

    const filtered = products.filter(p => {
      // فلترة البحث
      if(searchTerm){
        const t = (p.title || "").toLowerCase();
        const c = (p.category || "").toLowerCase();
        if(!t.includes(searchTerm) && !c.includes(searchTerm)) return false;
      }

      // فلترة التبويب
      if(currentFilter === "public"){
        return !p.accessVip;      // مفتوح فقط
      }
      if(currentFilter === "vip"){
        return !!p.accessVip;     // VIP فقط
      }
      return true;                // الكل
    });

    filtered.forEach(p => {
      const card = document.createElement("article");
      card.className = "product-card" + (p.accessVip ? " vip" : "");

      const imgUrlRaw = p.image || "";
      const imgUrl    = normalizeDriveImageUrl(imgUrlRaw);

      const ratingSum   = typeof p.ratingSum === "number" ? p.ratingSum : 0;
      const ratingCount = typeof p.ratingCount === "number" ? p.ratingCount : 0;
      const avgRating   = ratingCount > 0 ? (ratingSum / ratingCount) : 0;
      const rounded     = Math.round(avgRating || 0);

      const ratingHtml = `
        <div class="rating-row">
          <div class="rating-stars">
            ${[1,2,3,4,5].map(i=>`
              <i class="fa-star ${i <= rounded ? 'fa-solid' : 'fa-regular'}" data-value="${i}"></i>
            `).join('')}
          </div>
          <div class="rating-num">${avgRating ? avgRating.toFixed(1) : 'لا يوجد تقييم'}</div>
        </div>
      `;

      card.innerHTML = `
        <div class="product-image-box">
          ${imgUrl ? `<img loading="lazy" src="${imgUrl}" alt="">` : ""}
        </div>
        <div class="product-title">${p.title || "منتج بدون عنوان"}</div>
        ${ratingHtml}
        <div class="product-meta">
          <span>ID: ${p.id ?? "-"}</span>
          <span>${p.category || ""}</span>
        </div>
        <div class="product-footer">
          <div>
            <div class="category-text">${p.category || ""}</div>
            ${p.accessVip ? '<span class="badge-small vip">VIP</span>' : '<span class="badge-small">مفتوح</span>'}
          </div>
          <div class="product-actions">
            <button class="btn-share" title="مشاركة المنتج"><i class="fa-solid fa-share-nodes"></i></button>
            <button class="btn-enter"><i class="fa-solid fa-arrow-left"></i> دخول</button>
          </div>
        </div>
      `;

      card.querySelector(".btn-enter").addEventListener("click", () => openCourse(p));

      const stars = card.querySelectorAll(".rating-stars i");
      stars.forEach(star=>{
        star.addEventListener("click", ()=>{
          const val = parseInt(star.dataset.value,10) || 0;
          rateProduct(p, val);
        });
      });

      const shareBtn = card.querySelector(".btn-share");
      shareBtn.addEventListener("click", ()=> shareProduct(p));

      productsGrid.appendChild(card);
    });

    if(!filtered.length){
      const empty = document.createElement("div");
      empty.style.gridColumn = "1 / -1";
      empty.style.fontSize = "12px";
      empty.style.color = "var(--muted)";
      empty.textContent = "لا توجد منتجات ضمن هذا الفلتر حالياً.";
      productsGrid.appendChild(empty);
    }
  }

  function renderCoursesIndex(){
    const ul = document.getElementById("coursesIndexList");
    if(!ul) return;
    ul.innerHTML = "";

    const list = products.filter(p=>{
      if(searchTerm){
        const t = (p.title || "").toLowerCase();
        const c = (p.category || "").toLowerCase();
        if(!t.includes(searchTerm) && !c.includes(searchTerm)) return false;
      }
      return p.id && p.title;
    });

    list.forEach(p=>{
      const cat = (p.category || "").toLowerCase();
      let catLabel = "منتج";
      if (cat.includes("course"))   catLabel = "كورس تعليمي";
      else if (cat.includes("app")) catLabel = "تطبيق";
      else if (cat.includes("script")) catLabel = "سكربت";
      else if (cat.includes("template")) catLabel = "قالب جاهز";
      else if (cat.includes("tool")) catLabel = "أداة تكنولوجية";

      const li = document.createElement("li");
      const a  = document.createElement("a");
      a.href = "?p=" + encodeURIComponent(p.id);
      a.textContent = `${p.title} – ${catLabel} من متجر فن التكلوجيا الحديث (ID: ${p.id})`;
      a.style.color = "#9ca3af";
      a.style.textDecoration = "none";
      li.appendChild(a);
      ul.appendChild(li);
    });
  }

  filterChips.forEach(chip => {
    chip.addEventListener("click", () => {
      filterChips.forEach(c => c.classList.remove("active"));
      chip.classList.add("active");
      currentFilter = chip.dataset.filter;
      renderProducts();
      renderCoursesIndex();
    });
  });

  // فتح الكورس + تشغيل الفيديو داخل الصفحة
  function openCourse(product){
    overlay.classList.add("active");
    courseTitleHead.textContent = product.title || "";

    coursePreview.innerHTML = "";
    coursePreview.style.display = "none";
    openFieldsBox.innerHTML = "";
    vipFieldsBox.innerHTML  = "";

    let anyOpen = false;
    let anyVip  = false;
    let previewSet = false;

    const now = new Date();
    const activeVip = isVip && vipUntil && vipUntil > now;

    const poster = normalizeDriveImageUrl(product.image || "");

    function setPreview(url){
      if(!url) return;
      coursePreview.innerHTML = buildVideoElement(url, poster);
      coursePreview.style.display = "block";
    }

    if(Array.isArray(product.resources)){
      product.resources.forEach((r, index) => {
        const isVid = isVideoUrl(r.url);
        const title = r.title || ("عنصر " + (index+1));

        // أول فيديو متاح يشتغل تلقائياً كمعاينة
        if(isVid && !previewSet && ((r.access !== "vip") || (r.access === "vip" && activeVip))){
          setPreview(r.url);
          previewSet = true;
        }

        // VIP
        if(r.access === "vip"){
          anyVip = true;
          const item = document.createElement("div");
          item.className = "field-item";
          let actionsHtml = "";

          if(activeVip){
            if(isVid){
              actionsHtml = `
                <button class="inline-play-btn">تشغيل داخل الصفحة</button>
                <a href="${r.url}" target="_blank">فتح الفيديو</a>
              `;
            }else{
              actionsHtml = `<a href="${r.url}" target="_blank">فتح الرابط</a>`;
            }
          }else{
            actionsHtml = '<span>VIP مقفول</span>';
          }

          item.innerHTML = `
            <div class="field-main">
              <i class="fa-solid fa-crown" style="color:var(--accent3);"></i>
              <span>${title}</span>
            </div>
            <div class="field-actions">
              ${actionsHtml}
            </div>
          `;

          const btn = item.querySelector(".inline-play-btn");
          if(btn && activeVip && isVid){
            btn.addEventListener("click", () => setPreview(r.url));
          }

          vipFieldsBox.appendChild(item);
        }else{
          // مفتوح
          anyOpen = true;
          const item = document.createElement("div");
          item.className = "field-item";
          let actionsHtml = "";

          if(isVid){
            actionsHtml = `
              <button class="inline-play-btn">تشغيل داخل الصفحة</button>
              <a href="${r.url}" target="_blank">فتح الرابط</a>
            `;
          }else{
            actionsHtml = `<a href="${r.url}" target="_blank">فتح الرابط</a>`;
          }

          item.innerHTML = `
            <div class="field-main">
              <i class="fa-solid fa-circle-play" style="color:var(--accent);"></i>
              <span>${title}</span>
            </div>
            <div class="field-actions">
              ${actionsHtml}
            </div>
          `;

          const btn = item.querySelector(".inline-play-btn");
          if(btn && isVid){
            btn.addEventListener("click", () => setPreview(r.url));
          }

          openFieldsBox.appendChild(item);
        }
      });
    }

    noOpenFields.style.display = anyOpen ? "none" : "block";

    if(!anyVip){
      vipFieldsBox.innerHTML = '<div style="font-size:11px;color:var(--muted);">لا توجد حقول VIP في هذا الكورس.</div>';
      vipLockedMsg.style.display = "none";
      vipSectionBadge.textContent = "لا يوجد VIP";
    }else{
      if(activeVip){
        vipLockedMsg.style.display = "none";
        vipSectionBadge.textContent = "مفتوح لك";
      }else{
        vipLockedMsg.style.display = "block";
        vipSectionBadge.textContent = "مقفول";
      }
    }
  }

  backBtn.addEventListener("click", () => {
    overlay.classList.remove("active");
  });

  function maskPassword(p){
    if(!p) return "لم يتم تعيين كلمة سر";
    return "•".repeat(Math.max(p.length,4));
  }

  accountBtn.addEventListener("click", ()=>{
    accountModal.classList.add("open");
    accIdText.textContent = currentUserId || "--";
    if(userPassword){
      accPassText.textContent = maskPassword(userPassword);
      passEyeBtn.disabled = false;
      accNote.textContent = "يمكنك إظهار كلمة السر لمدة ٣٠ ثانية فقط.";
    }else{
      accPassText.textContent = "لم يتم تعيين كلمة سر بعد.";
      passEyeBtn.disabled = true;
      accNote.textContent = "قم بتعيين كلمة سر من صندوق (إعداد الحساب) في الأسفل.";
    }
  });

  accountCloseBtn.addEventListener("click", ()=>{
    accountModal.classList.remove("open");
    if(passTimer){clearTimeout(passTimer);passTimer=null;}
  });
  accountModal.addEventListener("click", (e)=>{
    if(e.target === accountModal){
      accountCloseBtn.click();
    }
  });

  passEyeBtn.addEventListener("click", ()=>{
    if(!userPassword) return;
    if(passTimer){clearTimeout(passTimer);}
    accPassText.textContent = userPassword;
    passEyeBtn.disabled = true;
    accNote.textContent = "سيتم إخفاء كلمة السر تلقائياً بعد ٣٠ ثانية.";
    passTimer = setTimeout(()=>{
      accPassText.textContent = maskPassword(userPassword);
      passEyeBtn.disabled = false;
      accNote.textContent = "يمكنك إظهار كلمة السر لمدة ٣٠ ثانية فقط.";
    }, 30000);
  });

  if(storeLogoutBtn){
    storeLogoutBtn.addEventListener("click", ()=>{
      localStorage.removeItem("FTM_USER_ID");
      localStorage.removeItem("FTM_USER_PASS");
      location.href = location.pathname;
    });
  }

  function shareProduct(p){
    const baseUrl = window.location.origin + window.location.pathname;
    const url = baseUrl + "?p=" + encodeURIComponent(p.id);
    const text = "شوف هذا المنتج في متجر فن التكلوجيا الحديث: " + (p.title || "منتج");
    if(navigator.share){
      navigator.share({
        title: p.title || "منتج",
        text,
        url
      }).catch(()=>{});
    }else{
      if(navigator.clipboard){
        navigator.clipboard.writeText(url).then(()=>{
          alert("تم نسخ رابط المنتج:\n" + url);
        }).catch(()=>{
          alert("رابط المنتج:\n" + url);
        });
      }else{
        alert("رابط المنتج:\n" + url);
      }
    }
  }

  function rateProduct(product, value){
    if(!value || value < 1 || value > 5) return;
    if(ratedProducts.includes(product.id)){
      alert("قيّمت هذا المنتج من قبل.");
      return;
    }
    const ref = db.collection("products").doc(String(product.id));
    ref.set({
      ratingSum: firebase.firestore.FieldValue.increment(value),
      ratingCount: firebase.firestore.FieldValue.increment(1)
    }, {merge:true})
    .then(()=>{
      ratedProducts.push(product.id);
      localStorage.setItem("FTM_RATED", JSON.stringify(ratedProducts));
      loadProducts();
    })
    .catch(err=>{
      console.error(err);
      alert("حدث خطأ أثناء حفظ التقييم.");
    });
  }

  (async function start(){
    await initUser();
    await initVisitors();
    await loadProducts();
    await loadWelcomeAd();
  })();
</script>
<section style="max-width:900px;margin:40px auto 20px;padding:20px;color:#fff;">
  <h2>ما هو متجر فن التكنولوجيا الحديث؟</h2>
  <p>
    فن التكنولوجيا الحديث هو متجر كورسات وتطبيقات وبرامج VIP، يقدّم محتوى تقني وتعليمي
    جاهز للاستخدام. من خلال حساب واحد يمكنك الوصول إلى الدورات، التطبيقات المدفوعة،
    الأدوات التعليمية، والملفات الاحترافية في مجالات البرمجة، التصميم، الذكاء الاصطناعي،
    IPTV، المونتاج، والهاتف.
  </p>
  <p>
    نعمل على توفير محتوى موثوق بأسعار بسيطة مع دعم فني مستمر، حتى تستفيد من كل أداة أو
    كورس تشتريه من المتجر بسهولة وأمان.
  </p>
</section>

<section style="max-width:900px;margin:0 auto 40px;padding:20px;color:#fff;">
  <h2>مميزات الاشتراك في حساب VIP</h2>
  <ul>
    <li>الوصول إلى جميع الحقول المغلقة داخل الكورسات والبرامج.</li>
    <li>تحديثات مستمرة على التطبيقات والملفات بدون رسوم إضافية.</li>
    <li>دعم فني عبر واتساب لحل أي مشكلة تواجهك.</li>
    <li>إضافة محتوى جديد بشكل دوري في مجالات مختلفة.</li>
  </ul>
</section>
</body>
</html>
