<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <!-- ========== META & SEO ========== -->
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <title>فن التكلوجيا الحديث | كورسات مجانية و VIP - برامج مهكرة ومعدلة وقوالب وأدوات</title>

  <meta name="description" content="فن التكلوجيا الحديث: متجر كورسات مجانية و VIP، برامج تعليم، أدوات تكنولوجيا، برامج مهكرة ومعدلة للتجربة، قوالب جاهزة، سكربتات، سيرفرات، وثغرات تعليمية في مجال الأمن والحماية.">
  <meta name="keywords" content="فن التكلوجيا الحديث, متجر كورسات, كورسات مجانية, كورسات VIP, برامج تعليم, برامج مهكرة, برامج معدلة, برامج هكر, ثغرات تعليمية, قوالب جاهزة, قوالب بلوجر, سكربتات, أدوات اختراق تعليمية, أدوات تكنولوجيا, دورات برمجة, دورات تصميم, سيرفرات مدفوعة, سيرفرات IPTV, ذكاء اصطناعي, AI, ادوات هكر للتعليم, ادوات حماية, قنوات تيليجرام تعليمية">
  <meta name="author" content="Basm / فن التكلوجيا الحديث">

  <!-- Open Graph (فيسبوك / واتساب) -->
  <meta property="og:title" content="فن التكلوجيا الحديث – كورسات، برامج، محتوى VIP">
  <meta property="og:description" content="كورسات مجانية ومدفوعة، برامج تعليم، أدوات مهكرة ومعدلة للتجربة، محتوى VIP بسعر رمزي، كل شيء في مكان واحد.">
  <meta property="og:image" content="https://k.top4top.io/p_3620yt6g21.jpg">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://example.com">

  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="فن التكلوجيا الحديث – كورسات و أدوات VIP">
  <meta name="twitter:description" content="متجر كورسات + برامج مهكرة ومعدلة للتجربة + أدوات تكنولوجيا حديثة.">
  <meta name="twitter:image" content="https://k.top4top.io/p_3620yt6g21.jpg">

  <!-- Favicon -->
  <link rel="icon" href="https://k.top4top.io/p_3620yt6g21.jpg" type="image/jpeg">

  <!-- خطوط و أيقونات -->
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />

  <style>
    :root {
      --bg: #020617;
      --card: rgba(15,23,42,0.98);
      --accent: #22d3ee;
      --accent2: #a855f7;
      --accent3: #facc15;
      --danger: #ef4444;
      --success: #10b981;
      --border: rgba(148,163,184,0.35);
      --text: #e5e7eb;
      --muted: #9ca3af;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:"Tajawal",system-ui,sans-serif;
      background:
        radial-gradient(circle at top,rgba(56,189,248,0.16),transparent 60%),
        radial-gradient(circle at bottom,rgba(168,85,247,0.16),transparent 55%),
        linear-gradient(135deg,#020617,#020617 40%,#030b1e);
      color:var(--text);
      min-height:100vh;
    }
    header{
      padding:10px 14px;
      border-bottom:1px solid var(--border);
      background:linear-gradient(90deg,rgba(15,23,42,0.98),rgba(15,23,42,0.9));
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .logo{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .logo-icon{
      width:34px;height:34px;border-radius:50%;
      border:2px solid var(--accent);
      display:flex;align-items:center;justify-content:center;
      box-shadow:0 0 18px rgba(34,211,238,0.7);
      background:radial-gradient(circle,rgba(34,211,238,0.2),transparent);
    }
    .logo-icon img{
      width:22px;height:22px;border-radius:50%;object-fit:cover;
    }
    .logo-text{display:flex;flex-direction:column;line-height:1.1}
    .logo-title{font-size:16px;font-weight:700}
    .logo-sub{font-size:11px;color:var(--muted)}
    .user-chip{
      font-size:11px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid var(--border);
      background:rgba(15,23,42,0.95);
      display:flex;
      flex-direction:column;
      align-items:flex-end;
      gap:2px;
    }
    .user-chip span:last-child{color:var(--accent);font-weight:600}

    main{max-width:1100px;margin:10px auto 20px;padding:0 10px}

    .user-status-bar{
      background:rgba(15,23,42,0.97);
      border-radius:14px;
      border:1px solid var(--border);
      padding:8px 10px;
      margin-bottom:10px;
      display:grid;
      grid-template-columns:minmax(0,2.2fr) minmax(0,2fr);
      gap:6px;
      align-items:center;
    }
    @media(max-width:768px){
      .user-status-bar{
        grid-template-columns:1fr;
      }
    }
    .user-status-text{font-size:11px;color:var(--muted);}
    .user-status-pill{display:flex;gap:6px;align-items:center;flex-wrap:wrap;}
    .badge{
      padding:3px 7px;
      border-radius:999px;
      font-size:11px;
      border:1px solid var(--border);
      display:inline-flex;
      align-items:center;
      gap:4px;
    }
    .badge.vip{border-color:var(--accent3);color:var(--accent3);}
    .badge.notvip{border-color:var(--muted);color:var(--muted);}
    .btn-vip{
      border-radius:999px;
      border:none;
      padding:6px 10px;
      font-size:11px;
      cursor:pointer;
      background:linear-gradient(90deg,#22c55e,#16a34a);
      color:#022c22;
      display:inline-flex;
      align-items:center;
      gap:5px;
      font-weight:600;
    }
    .btn-vip i{font-size:12px}
    .vip-pricing{
      font-size:11px;
      color:var(--muted);
    }
    .vip-pricing span{color:var(--accent3);font-weight:600}

    .profile-box{
      background:rgba(15,23,42,0.96);
      border-radius:14px;
      border:1px dashed rgba(148,163,184,0.7);
      padding:8px 10px;
      margin-bottom:12px;
      font-size:11px;
    }
    .profile-row{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      align-items:center;
      margin-top:6px;
    }
    .profile-row input{
      background:rgba(15,23,42,0.96);
      border-radius:999px;
      border:1px solid rgba(51,65,85,0.95);
      padding:5px 8px;
      color:var(--text);
      font-size:11px;
      min-width:120px;
    }
    .profile-row button{
      border-radius:999px;
      border:none;
      padding:5px 10px;
      font-size:11px;
      cursor:pointer;
      background:rgba(37,99,235,0.95);
      color:white;
    }

    .filters{
      display:flex;
      gap:6px;
      flex-wrap:wrap;
      margin-bottom:8px;
      font-size:11px;
    }
    .filter-chip{
      padding:4px 8px;
      border-radius:999px;
      border:1px solid var(--border);
      background:rgba(15,23,42,0.96);
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:4px;
      color:var(--muted);
    }
    .filter-chip.active{
      border-color:var(--accent);
      color:var(--accent);
      box-shadow:0 0 12px rgba(34,211,238,0.4);
    }

    .products-grid{
      display:grid;
      grid-template-columns:repeat(2,minmax(0,1fr));
      gap:10px;
    }
    @media(min-width:900px){
      .products-grid{grid-template-columns:repeat(4,minmax(0,1fr));}
    }
    @media(min-width:1200px){
      .products-grid{grid-template-columns:repeat(6,minmax(0,1fr));}
    }

    .product-card{
      background:rgba(15,23,42,0.98);
      border-radius:14px;
      border:1px solid rgba(55,65,81,0.9);
      padding:6px;
      display:flex;
      flex-direction:column;
      gap:4px;
      position:relative;
      overflow:hidden;
    }
    .product-card.vip{
      box-shadow:0 0 18px rgba(250,204,21,0.35);
      border-color:rgba(250,204,21,0.85);
    }
    .product-image-box{
      width:100%;
      padding-top:100%;
      border-radius:10px;
      overflow:hidden;
      background:radial-gradient(circle,rgba(15,23,42,0.7),#020617);
      position:relative;
    }
    .product-image-box img{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      object-fit:cover;
    }
    .product-title{
      font-size:12px;
      font-weight:600;
      margin-top:2px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .product-footer{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-top:2px;
      gap:4px;
    }
    .category-text{font-size:10px;color:var(--muted);}
    .badge-small{
      font-size:10px;
      padding:2px 6px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.8);
    }
    .badge-small.vip{border-color:var(--accent3);color:var(--accent3);}
    .btn-enter{
      border:none;
      border-radius:999px;
      padding:4px 10px;
      font-size:11px;
      cursor:pointer;
      background:#ef4444;
      color:#fee2e2;
      display:inline-flex;
      align-items:center;
      gap:4px;
    }

    .course-overlay{
      position:fixed;
      inset:0;
      background:rgba(15,23,42,0.96);
      z-index:40;
      display:none;
      flex-direction:column;
    }
    .course-overlay.active{display:flex;}
    .course-header{
      padding:8px 10px;
      border-bottom:1px solid var(--border);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:6px;
      background:rgba(15,23,42,0.98);
    }
    .course-header button{
      border:none;
      background:rgba(15,23,42,0.96);
      border-radius:999px;
      padding:4px 8px;
      color:var(--text);
      font-size:11px;
      display:inline-flex;
      align-items:center;
      gap:4px;
      cursor:pointer;
    }
    .course-title{font-size:13px;font-weight:600;}
    .course-body{
      padding:10px;
      overflow:auto;
      flex:1;
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    /* فيديو المعاينة */
    .preview-box{
      max-width:480px;
      margin:0 auto;
      border-radius:14px;
      overflow:hidden;
      border:1px solid rgba(55,65,81,0.9);
      background:#000;
    }
    .preview-box iframe,
    .preview-box video{
      width:100%;
      height:260px;
      display:block;
    }
    @media(max-width:600px){
      .preview-box iframe,
      .preview-box video{height:210px;}
    }

    .section-box{
      background:rgba(15,23,42,0.98);
      border-radius:14px;
      border:1px solid var(--border);
      padding:8px 10px;
      font-size:12px;
    }
    .section-title{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:6px;
      font-size:12px;
    }
    .section-title span{display:flex;align-items:center;gap:6px;}
    .field-list{display:flex;flex-direction:column;gap:6px;}
    .field-item{
      padding:6px 8px;
      border-radius:10px;
      border:1px solid rgba(51,65,85,0.9);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:6px;
      font-size:11px;
    }
    .field-main{display:flex;align-items:center;gap:6px;}
    .field-actions a{
      font-size:11px;
      text-decoration:none;
      color:var(--accent);
    }
    .field-actions span{
      font-size:11px;
      color:#fecaca;
    }
    .vip-locked{
      font-size:11px;
      color:#fecaca;
      background:rgba(185,28,28,0.15);
      border-radius:10px;
      padding:6px 8px;
      border:1px solid rgba(248,113,113,0.7);
      margin-top:6px;
    }

    /* فوتر بسيط للكلمات المفتاحية */
    .seo-footer{
      font-size:10px;
      color:var(--muted);
      opacity:0.8;
      margin-top:12px;
      padding:0 4px 8px;
    }
  </style>
</head>

<body>

<header>
  <div class="logo">
    <div class="logo-icon">
      <img src="https://k.top4top.io/p_3620yt6g21.jpg" alt="Logo">
    </div>
    <div class="logo-text">
      <div class="logo-title">فن التكلوجيا الحديث</div>
      <div class="logo-sub">متجر كورسات – تكنولوجيا حديثة &amp; VIP</div>
    </div>
  </div>
  <div class="user-chip">
    <span>حالة الحساب: <strong id="accountStateText">...</strong></span>
    <span>ID: <span id="userIdChip">----</span></span>
  </div>
</header>

<main>

  <!-- شريط الاشتراك المختصر -->
  <section class="user-status-bar">
    <div>
      <div class="user-status-text" id="vipShortText">
        يتم تحديد حالة اشتراكك من السيرفر...
      </div>
      <div class="vip-pricing">
        الاشتراك في <span>VIP</span> لفتح مزايا الموقع:
        شهر واحد <span>5$</span> – ثلاثة أشهر <span>10$</span>.
      </div>
    </div>
    <div class="user-status-pill">
      <button class="btn-vip" id="vipWhatsappBtn">
        <i class="fa-brands fa-whatsapp"></i>
        أريد تفعيل اشتراك VIP
      </button>
      <span class="badge" id="vipStateBadge"><i class="fa-solid fa-circle-info"></i> يتم التحقق ...</span>
    </div>
  </section>

  <!-- إعداد الحساب -->
  <section class="profile-box">
    <div>حسابك محفوظ على هذا الجهاز. إذا رجعت لاحقًا، استخدم نفس <strong>ID</strong> وكلمة السر.</div>
    <div class="profile-row">
      <span>ID الحالي:</span>
      <span id="userIdDisplay" style="font-weight:600;"></span>
    </div>
    <div class="profile-row">
      <span>أنشئ كلمة سر:</span>
      <input type="password" id="passwordInput" placeholder="٢-١٢ حرف / رقم">
      <button id="savePasswordBtn">حفظ الحساب</button>
      <span id="passwordStatus"></span>
    </div>
  </section>

  <!-- فلاتر -->
  <section class="filters">
    <button class="filter-chip active" data-filter="all">الكل</button>
    <button class="filter-chip" data-filter="public">مفتوح</button>
    <button class="filter-chip" data-filter="vip">VIP</button>
  </section>

  <!-- شبكة المنتجات -->
  <section class="products-grid" id="productsGrid"></section>

  <!-- فوتر للكلمات المفتاحية (قابل للقراءة) -->
  <footer class="seo-footer">
    فن التكلوجيا الحديث هو متجر كورسات مجانية ومدفوعة، كورسات VIP، برامج تعليم، برامج مهكرة ومعدلة للتجربة، أدوات هكر تعليمية، أدوات حماية، قوالب جاهزة، سكربتات، سيرفرات، وثغرات تعليمية في مجال الأمن والحماية والتكنولوجيا الحديثة.
  </footer>

</main>

<!-- صفحة الكورس -->
<div class="course-overlay" id="courseOverlay">
  <div class="course-header">
    <button id="courseBackBtn"><i class="fa-solid fa-arrow-right"></i> رجوع للمتجر</button>
    <div class="course-title" id="courseTitleHead"></div>
  </div>
  <div class="course-body">
    <div id="coursePreview" class="preview-box" style="display:none;"></div>

    <div class="section-box" id="openSection">
      <div class="section-title">
        <span><i class="fa-solid fa-unlock"></i> المحتوى المفتوح / القديم</span>
        <small style="color:var(--muted);font-size:10px;">يُعرض للجميع</small>
      </div>
      <div class="field-list" id="openFields"></div>
      <div id="noOpenFields" style="font-size:11px;color:var(--muted);display:none;">
        لا توجد حقول مفتوحة في هذا الكورس حاليًا.
      </div>
    </div>

    <div class="section-box" id="vipSection">
      <div class="section-title">
        <span><i class="fa-solid fa-crown"></i> محتوى VIP</span>
        <span class="badge-small vip" id="vipSectionBadge">مقفول</span>
      </div>
      <div class="field-list" id="vipFields"></div>
      <div class="vip-locked" id="vipLockedMsg">
        هذا المحتوى VIP – عليك الاشتراك لكي تتمتع باستخدام كل الحقول المقفولة.
        اضغط على زر الاشتراك في الأعلى لتواصل الأدمن عبر الواتساب.
      </div>
    </div>
  </div>
</div>

<!-- Firebase v8 -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyDa_20ADHMOiUhueZL9PS3WHmA89fGLfhk",
    authDomain: "mtgr-5feb9.firebaseapp.com",
    projectId: "mtgr-5feb9",
    storageBucket: "mtgr-5feb9.firebasestorage.app",
    messagingSenderId: "1097780736802",
    appId: "1:1097780736802:web:89ea173d277ce529a56b7b",
    measurementId: "G-JWNEHDQ31F"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  const WHATSAPP_NUMBER = "9647729373260";

  let currentUserId = null;
  let isVip = false;
  let vipUntil = null;
  let products = [];
  let currentFilter = "all";

  const userIdChip      = document.getElementById("userIdChip");
  const userIdDisplay   = document.getElementById("userIdDisplay");
  const accountStateTxt = document.getElementById("accountStateText");
  const vipShortText    = document.getElementById("vipShortText");
  const vipStateBadge   = document.getElementById("vipStateBadge");
  const vipBtn          = document.getElementById("vipWhatsappBtn");

  const passwordInput  = document.getElementById("passwordInput");
  const savePassBtn    = document.getElementById("savePasswordBtn");
  const passwordStatus = document.getElementById("passwordStatus");

  const productsGrid   = document.getElementById("productsGrid");
  const filterChips    = document.querySelectorAll(".filter-chip");

  const overlay        = document.getElementById("courseOverlay");
  const backBtn        = document.getElementById("courseBackBtn");
  const courseTitleHead= document.getElementById("courseTitleHead");
  const coursePreview  = document.getElementById("coursePreview");
  const openFieldsBox  = document.getElementById("openFields");
  const vipFieldsBox   = document.getElementById("vipFields");
  const noOpenFields   = document.getElementById("noOpenFields");
  const vipLockedMsg   = document.getElementById("vipLockedMsg");
  const vipSectionBadge= document.getElementById("vipSectionBadge");

  function generateUserId(){
    const rand = Math.floor(100000 + Math.random()*900000);
    return "U" + rand;
  }

  async function initUser(){
    currentUserId = localStorage.getItem("FTM_USER_ID");
    let userPass  = localStorage.getItem("FTM_USER_PASS");

    if(!currentUserId){
      currentUserId = generateUserId();
      localStorage.setItem("FTM_USER_ID", currentUserId);
    }

    userIdChip.textContent    = currentUserId;
    userIdDisplay.textContent = currentUserId;

    if(userPass){
      passwordInput.value = userPass;
    }

    const userRef  = db.collection("users").doc(currentUserId);
    const userSnap = await userRef.get();

    if(!userSnap.exists){
      await userRef.set({
        id: currentUserId,
        password: userPass || "",
        isVip: false,
        vipUntil: null,
        createdAt: new Date().toISOString()
      });
      isVip = false;
      vipUntil = null;
    }else{
      const data = userSnap.data();
      isVip = !!data.isVip;
      vipUntil = data.vipUntil ? new Date(data.vipUntil) : null;

      if(data.password && !userPass){
        localStorage.setItem("FTM_USER_PASS", data.password);
        passwordInput.value = data.password;
      }
    }

    updateVipUI();

    const baseText = encodeURIComponent("أريد تفعيل اشتراك VIP في متجر فن التكلوجيا الحديث. ID: " + currentUserId);
    const waLink = "https://wa.me/" + WHATSAPP_NUMBER + "?text=" + baseText;
    vipBtn.addEventListener("click", () => {
      window.open(waLink, "_blank");
    });
  }

  function updateVipUI(){
    const now = new Date();
    let activeVip = false;
    if(isVip && vipUntil && vipUntil > now) {
      activeVip = true;
    }

    if(activeVip){
      accountStateTxt.textContent = "مشترك (VIP)";
      accountStateTxt.style.color = "#22c55e";
      vipShortText.textContent = "حسابك مفعل VIP – يمكنك الوصول إلى جميع الحقول المقفولة داخل الدورات.";
      vipStateBadge.innerHTML = '<i class="fa-solid fa-crown"></i> حسابك VIP نشط';
      vipStateBadge.classList.remove("notvip");
      vipStateBadge.classList.add("vip");
      vipLockedMsg.style.display = "none";
      vipSectionBadge.textContent = "مفتوح لك";
    }else{
      accountStateTxt.textContent = "غير مشترك";
      accountStateTxt.style.color = "#f97316";
      vipShortText.textContent = "حالياً تستخدم الحساب المجاني – يمكن مشاهدة المحتوى المفتوح فقط، محتوى VIP يحتاج اشتراك.";
      vipStateBadge.innerHTML = '<i class="fa-solid fa-lock"></i> غير مشترك';
      vipStateBadge.classList.remove("vip");
      vipStateBadge.classList.add("notvip");
      vipLockedMsg.style.display = "block";
      vipSectionBadge.textContent = "مقفول";
    }
  }

  savePassBtn.addEventListener("click", async () => {
    const pass = passwordInput.value.trim();
    if(pass.length < 2 || pass.length > 12){
      passwordStatus.textContent = "كلمة السر بين ٢ و١٢ رمز.";
      passwordStatus.style.color = "#fecaca";
      return;
    }
    try{
      await db.collection("users").doc(currentUserId).set({
        id: currentUserId,
        password: pass,
        isVip,
        vipUntil: vipUntil ? vipUntil.toISOString() : null
      }, { merge:true });

      localStorage.setItem("FTM_USER_PASS", pass);
      passwordStatus.textContent = "تم حفظ الحساب.";
      passwordStatus.style.color = "#22c55e";
    }catch(e){
      console.error(e);
      passwordStatus.textContent = "خطأ في الحفظ.";
      passwordStatus.style.color = "#fecaca";
    }
  });

  async function loadProducts(){
    const snap = await db.collection("products").get();
    products = [];
    snap.forEach(docSnap => {
      const data = docSnap.data();
      products.push(data);
    });
    renderProducts();
  }

  function renderProducts(){
    productsGrid.innerHTML = "";
    const filtered = products.filter(p => {
      if(currentFilter === "public"){
        return Array.isArray(p.resources) && p.resources.some(r => r.access === "public");
      }
      if(currentFilter === "vip"){
        return Array.isArray(p.resources) && p.resources.some(r => r.access === "vip");
      }
      return true;
    });

    filtered.forEach(p => {
      const card = document.createElement("article");
      card.className = "product-card" + (p.accessVip ? " vip" : "");
      const imgUrl = p.image || "";
      card.innerHTML = `
        <div class="product-image-box">
          ${imgUrl ? `<img src="${imgUrl}" alt="">` : ""}
        </div>
        <div class="product-title">${p.title || "منتج بدون عنوان"}</div>
        <div class="product-footer">
          <div>
            <div class="category-text">${p.category || ""}</div>
            ${p.accessVip ? '<span class="badge-small vip">VIP</span>' : '<span class="badge-small">مفتوح</span>'}
          </div>
          <button class="btn-enter"><i class="fa-solid fa-arrow-left"></i> دخول</button>
        </div>
      `;
      card.querySelector(".btn-enter").addEventListener("click", () => openCourse(p));
      productsGrid.appendChild(card);
    });

    if(!filtered.length){
      const empty = document.createElement("div");
      empty.style.gridColumn = "1 / -1";
      empty.style.fontSize = "12px";
      empty.style.color = "var(--muted)";
      empty.textContent = "لا توجد منتجات ضمن هذا الفلتر حالياً.";
      productsGrid.appendChild(empty);
    }
  }

  filterChips.forEach(chip => {
    chip.addEventListener("click", () => {
      filterChips.forEach(c => c.classList.remove("active"));
      chip.classList.add("active");
      currentFilter = chip.dataset.filter;
      renderProducts();
    });
  });

  function isVideoUrl(url){
    if(!url) return false;
    const u = url.toLowerCase();
    return u.includes("youtube.com") || u.includes("youtu.be") ||
           u.endsWith(".mp4") || u.endsWith(".webm") || u.endsWith(".ogg");
  }

  // فيديو المعاينة مع poster = صورة المنتج
  function buildVideoElement(url, poster){
    if(url.includes("youtube.com") || url.includes("youtu.be")){
      let videoId = "";
      try{
        if(url.includes("youtube.com")){
          const params = new URL(url).searchParams;
          videoId = params.get("v") || "";
        }else{
          const parts = url.split("/");
          videoId = parts[parts.length - 1];
        }
      }catch(e){}
      if(!videoId) return `<a href="${url}" target="_blank">فتح الفيديو</a>`;
      const embed = "https://www.youtube.com/embed/" + videoId;
      return `<iframe src="${embed}" frameborder="0" allowfullscreen></iframe>`;
    }else{
      const posterAttr = poster ? ` poster="${poster}"` : "";
      return `<video controls src="${url}"${posterAttr}></video>`;
    }
  }

  function openCourse(product){
    overlay.classList.add("active");
    courseTitleHead.textContent = product.title || "";

    coursePreview.innerHTML = "";
    coursePreview.style.display = "none";
    openFieldsBox.innerHTML = "";
    vipFieldsBox.innerHTML  = "";

    let anyOpen = false;
    let anyVip  = false;
    let previewSet = false;

    const now = new Date();
    const activeVip = isVip && vipUntil && vipUntil > now;

    if(Array.isArray(product.resources)){
      product.resources.forEach((r, index) => {
        const isVid = isVideoUrl(r.url);
        const title = r.title || ("عنصر " + (index+1));

        if(isVid && !previewSet && ((r.access !== "vip") || (r.access === "vip" && activeVip))){
          coursePreview.innerHTML = buildVideoElement(r.url, product.image || "");
          coursePreview.style.display = "block";
          previewSet = true;
          return;
        }

        if(r.access === "vip"){
          anyVip = true;
          const item = document.createElement("div");
          item.className = "field-item";
          item.innerHTML = `
            <div class="field-main">
              <i class="fa-solid fa-crown" style="color:var(--accent3);"></i>
              <span>${title}</span>
            </div>
            <div class="field-actions">
              ${
                activeVip
                  ? (isVid ? '<a href="'+r.url+'" target="_blank">فتح الفيديو</a>'
                           : '<a href="'+r.url+'" target="_blank">فتح الرابط</a>')
                  : '<span>VIP مقفول</span>'
              }
            </div>
          `;
          vipFieldsBox.appendChild(item);
        }else{
          anyOpen = true;
          const item = document.createElement("div");
          item.className = "field-item";
          item.innerHTML = `
            <div class="field-main">
              <i class="fa-solid fa-circle-play" style="color:var(--accent);"></i>
              <span>${title}</span>
            </div>
            <div class="field-actions">
              ${
                isVid
                  ? '<a href="'+r.url+'" target="_blank">فتح الفيديو</a>'
                  : '<a href="'+r.url+'" target="_blank">فتح الرابط</a>'
              }
            </div>
          `;
          openFieldsBox.appendChild(item);
        }
      });
    }

    noOpenFields.style.display = anyOpen ? "none" : "block";

    if(!anyVip){
      vipFieldsBox.innerHTML = '<div style="font-size:11px;color:var(--muted);">لا توجد حقول VIP في هذا الكورس.</div>';
      vipLockedMsg.style.display = "none";
      vipSectionBadge.textContent = "لا يوجد VIP";
    }else{
      if(activeVip){
        vipLockedMsg.style.display = "none";
        vipSectionBadge.textContent = "مفتوح لك";
      }else{
        vipLockedMsg.style.display = "block";
        vipSectionBadge.textContent = "مقفول";
      }
    }
  }

  backBtn.addEventListener("click", () => {
    overlay.classList.remove("active");
  });

  (async function start(){
    await initUser();
    await loadProducts();
  })();
</script>

</body>
</html>
